name: Claude QA Testing

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-qa:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: refs/pull/${{ steps.pr-number.outputs.number }}/head
          fetch-depth: 0

      - name: Setup DDEV
        uses: ddev/github-action-setup-ddev@v1
        with:
          autostart: false

      - name: Start DDEV project
        run: |
          ddev start

      - name: Get PR details
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ steps.pr-number.outputs.number }}
          PR_BODY=$(gh pr view $PR_NUMBER --json body -q .body)
          echo "pr_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create screenshots directory
        run: |
          mkdir -p /tmp/claude-qa-screenshots
          chmod 777 /tmp/claude-qa-screenshots

      - name: Run Claude QA Testing
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPOSITORY: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr-number.outputs.number }}

            PR DESCRIPTION:
            ${{ steps.pr-info.outputs.pr_body }}

            SITE URL: https://github-workflow.ddev.site

            ## Your Task

            You are a QA engineer testing this pull request from a USER PERSPECTIVE.
            DO NOT look at the code - test the feature as described in the PR description.

            ## IMPORTANT: Screenshot and Report Instructions

            Playwright MCP will automatically save screenshots to the `.playwright-mcp/` directory.
            You should also create your report files in the CURRENT WORKING DIRECTORY (not /tmp).

            Create these files:
            1. **REPORT.md** - Your main QA report
            2. **SCREENSHOTS.txt** - List of screenshots with descriptions
            
            When taking screenshots during testing:
            1. **Save ALL screenshots to**: `/tmp/claude-qa-screenshots/`
            2. **Use simple numbered names**: `01.png`, `02.png`, `03.png`, etc.
            3. **Limit to 8-10 screenshots** (most important ones)
            4. **Take screenshots of**:
               - Initial page state
               - Key functionality being tested
               - Any errors or issues found
               - Before/after states
            5. **Keep file sizes reasonable** (< 2MB per image if possible)

            Use Playwright MCP tools to:

            ### 1. FUNCTIONAL TESTING
            - Verify the feature works as described in the PR
            - Test all user interactions mentioned
            - Verify data accuracy and completeness
            - Test edge cases (empty data, special characters, etc.)

            ### 2. UI/UX TESTING
            - Verify links are visible and clearly labeled
            - Check error messages are helpful
            - Test responsiveness if applicable
            - Verify output format is user-friendly

            ## Testing Workflow

            1. Navigate to the site at https://github-workflow.ddev.site
            2. The page should be accessible.
            4. Take screenshots of key interactions
            5. Document any issues found

            ## Reporting Requirements

            Create **REPORT.md** in the current directory with this format:
            
            ```markdown
            - âœ… Tests that passed
            - âŒ Issues found (with severity: Critical/High/Medium/Low)
            - ðŸ“¸ Screenshots (01.png, 02.png,...) of problems.
            - ðŸ’¡ Recommendations for fixes
            ```

            Create **SCREENSHOTS.txt** in the current directory describing each screenshot:
            ```
            01.png|Homepage initial load
            02.png|Login form with valid credentials
            03.png|Error message for invalid input
            ```

            **DO NOT post comments using gh pr comment** - the workflow handles this.

          claude_args: |
            --max-turns 100
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless","--isolated","--caps=vision,testing"]}}}'
            --allowed-tools "mcp__playwright__browser_navigate,mcp__playwright__browser_navigate_back,mcp__playwright__browser_click,mcp__playwright__browser_type,mcp__playwright__browser_snapshot,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_console_messages,mcp__playwright__browser_wait_for,mcp__playwright__browser_hover,mcp__playwright__browser_resize,mcp__playwright__browser_drag,mcp__playwright__browser_select_option,mcp__playwright__browser_press_key,mcp__playwright__browser_tabs,mcp__playwright__browser_file_upload,mcp__playwright__browser_fill_form,mcp__playwright__browser_handle_dialog,mcp__playwright__browser_close,Bash(gh pr comment:*),Bash(gh pr view:*),Bash(gh pr diff:--name-only),Write"
    
      - name: Collect screenshots and reports
        if: always()
        run: |
          echo "Collecting screenshots and reports..."

          # Create collection directory
          mkdir -p /tmp/qa-artifacts

          # Copy report files from working directory
          if [ -f "REPORT.md" ]; then
            echo "Found REPORT.md"
            cp REPORT.md /tmp/qa-artifacts/
          else
            echo "REPORT.md not found in working directory"
            ls -la | grep -i report || echo "No report files found"
          fi

          if [ -f "SCREENSHOTS.txt" ]; then
            echo "Found SCREENSHOTS.txt"
            cp SCREENSHOTS.txt /tmp/qa-artifacts/
          else
            echo "SCREENSHOTS.txt not found"
          fi

          # Copy screenshots from .playwright-mcp directory
          if [ -d ".playwright-mcp" ]; then
            echo "Found .playwright-mcp directory"
            find .playwright-mcp -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) \
              -exec cp {} /tmp/qa-artifacts/ \; 2>/dev/null || true
          else
            echo ".playwright-mcp directory not found"
          fi

          # Also check current directory for screenshots
          find . -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" \) \
            -exec cp {} /tmp/qa-artifacts/ \; 2>/dev/null || true

          # Show what we collected
          echo "Collected files:"
          ls -lh /tmp/qa-artifacts/ || echo "No files collected"

          SCREENSHOT_COUNT=$(ls -1 /tmp/qa-artifacts/*.png /tmp/qa-artifacts/*.jpg 2>/dev/null | wc -l)
          echo "Total screenshots: $SCREENSHOT_COUNT"

      - name: Create and post PR comment with screenshots
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if artifacts were collected
          if [ ! -d "/tmp/qa-artifacts" ]; then
            echo "No artifacts found"
            exit 0
          fi

          cd /tmp/qa-artifacts

          # Install requests
          pip3 install requests --quiet

          # Create Python script to post comment
          cat > /tmp/post_comment.py << 'PYTHON_SCRIPT'
          import os
          import sys
          import requests
          from pathlib import Path

          github_token = os.environ['GH_TOKEN']
          repo = "${{ github.repository }}"
          pr_number = "${{ steps.pr-number.outputs.number }}"

          headers = {
              'Authorization': f'token {github_token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          artifacts_dir = Path('/tmp/qa-artifacts')

          # Read report if it exists
          report_file = artifacts_dir / 'REPORT.md'
          if report_file.exists():
              with open(report_file, 'r') as f:
                  report = f.read()
          else:
              report = "## ðŸ§ª QA Test Report\n\n_Report file not found._\n"

          # Read screenshot descriptions
          screenshot_descriptions = {}
          desc_file = artifacts_dir / 'SCREENSHOTS.txt'
          if desc_file.exists():
              with open(desc_file, 'r') as f:
                  for line in f:
                      if '|' in line:
                          filename, desc = line.strip().split('|', 1)
                          screenshot_descriptions[filename] = desc

          # Find all screenshots
          screenshots = sorted(list(artifacts_dir.glob('*.png')) + list(artifacts_dir.glob('*.jpg')))

          # Build comment
          comment_body = report + "\n\n---\n\n### ðŸ“¸ Screenshots\n\n"

          if not screenshots:
              comment_body += "_No screenshots were captured during testing._\n"
          else:
              comment_body += f"**{len(screenshots)} screenshot(s) captured:**\n\n"

              for idx, screenshot in enumerate(screenshots, 1):
                  filename = screenshot.name
                  desc = screenshot_descriptions.get(filename, filename)
                  comment_body += f"{idx}. **{filename}**: {desc}\n"

              # Add download link
              run_url = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              comment_body += f"\nðŸ“¦ **[Download all screenshots]({run_url}#artifacts)**\n"

          # Post comment
          comment_url = f'https://api.github.com/repos/{repo}/issues/{pr_number}/comments'
          comment_data = {'body': comment_body}

          response = requests.post(comment_url, headers=headers, json=comment_data)

          if response.status_code == 201:
              print("âœ… Comment posted successfully!")
          else:
              print(f"âŒ Failed to post comment: {response.status_code}")
              print(response.text)
          PYTHON_SCRIPT

          python3 /tmp/post_comment.py

      - name: Upload screenshots as artifacts (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-screenshots-pr-${{ steps.pr-number.outputs.number }}
          path: /tmp/claude-qa-screenshots/
          retention-days: 30
          if-no-files-found: ignore
